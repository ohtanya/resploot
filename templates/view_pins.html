{% extends "base.html" %}

{% block title %}
    {% if data.get('archive_type') == 'full_messages' %}
        📦 #{{ data.channel_name }}
    {% else %}
        📌 #{{ data.channel_name }}
    {% endif %}
{% endblock %}

{% block content %}
<div style="padding: 24px;">
    <div style="margin-bottom: 32px;">
        <a href="{{ url_for('index') }}" class="btn btn-ghost" style="margin-bottom: 20px;">← Back to Archives</a>
        
        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 16px;">
            <div style="width: 56px; height: 56px; border-radius: 16px; background: linear-gradient(135deg, #6b7280, #4b5563); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                {% if data.get('archive_type') == 'full_messages' %}◆{% else %}◆{% endif %}
            </div>
            <div>
                <h1 style="margin: 0; color: #f1f5f9; font-size: 28px; font-weight: 700;">
                    #{{ data.channel_name }}
                </h1>
                <p style="margin: 4px 0 0; color: #94a3b8; font-size: 16px;">
                    {% if data.get('archive_type') == 'full_messages' %}
                        {{ data.get('message_count', 0) }} messages • Full Archive
                    {% else %}
                        {{ data.get('pins', [])|length }} pins • Pins Only
                    {% endif %}
                </p>
                <p style="margin: 4px 0 0; color: #64748b; font-size: 14px;">
                    Archived {{ data.archived_date[:10] if data.archived_date else 'Unknown date' }}
                </p>
            </div>
        </div>
    </div>

    <!-- Search -->
    {% if data.get('archive_type') == 'full_messages' %}
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="🔍 Search messages..." />
    </div>
    {% endif %}

    <!-- Messages/Pins -->
    {% set items = data.messages if data.get('archive_type') == 'full_messages' else data.get('pins', []) %}
    <div id="messageContainer" style="padding-bottom: 40px;">
    {% if items %}
        {% for item in items %}
        <div class="message-item" data-content="{{ item.content|lower }}" style="background: linear-gradient(145deg, #1a1a1a, #262626); border: 1px solid #404040; border-radius: 12px; padding: 20px; margin-bottom: 16px; transition: all 0.2s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.3)'" onmouseout="this.style.boxShadow='none'">
            <!-- Author -->
            <div style="display: flex; align-items: center; margin-bottom: 16px; gap: 12px;">
                {% if item.author.avatar_url %}
                <img src="{{ item.author.avatar_url }}" alt="{{ item.author.name }}" 
                     style="width: 44px; height: 44px; border-radius: 50%; border: 2px solid #404040;">
                {% else %}
                <div style="width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg, #6b7280, #4b5563); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 16px;">
                    {{ item.author.name[0].upper() }}
                </div>
                {% endif %}
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">
                        <strong style="color: #f1f5f9; font-weight: 600;">{{ item.author.name }}</strong>
                        {% if item.get('is_pinned') %}
                        <span style="background: #451a03; color: #fbbf24; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500;">📌 Pinned</span>
                        {% endif %}
                    </div>
                    <div style="font-size: 13px; color: #94a3b8;">
                        {{ item.created_at[:19] if item.created_at else '' }}
                    </div>
                </div>
            </div>

            <!-- Content -->
            {% if item.content %}
            <div style="margin-bottom: 20px; color: #cbd5e1; line-height: 1.6; font-size: 15px;">
                {{ item.content|replace('\n', '<br>')|safe }}
            </div>
            {% endif %}

            <!-- Attachments -->
            {% if item.attachments %}
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 12px; color: #f1f5f9; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    📎 Attachments ({{ item.attachments|length }})
                </h4>
                <div style="display: grid; gap: 12px;">
                    {% for attachment in item.attachments %}
                    <div style="border: 1px solid #404040; border-radius: 8px; padding: 16px; background: #1a1a1a;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #f1f5f9; margin-bottom: 4px;">{{ attachment.filename }}</div>
                                <div style="font-size: 12px; color: #94a3b8; display: flex; gap: 12px;">
                                    {% if attachment.size %}
                                    <span>{{ "%.1f KB"|format(attachment.size / 1024) }}</span>
                                    {% endif %}
                                    {% if attachment.content_type %}
                                    <span>{{ attachment.content_type }}</span>
                                    {% endif %}
                                    {% if attachment.downloaded %}
                                    <span style="color: #34d399;">✅ Downloaded</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if attachment.downloaded and attachment.local_filename %}
                            <a href="{{ url_for('serve_attachment', filename=attachment.local_filename) }}" 
                               class="btn" style="padding: 6px 12px; font-size: 13px;" download="{{ attachment.filename }}">
                                💾 Download
                            </a>
                            {% endif %}
                        </div>
                        {% if attachment.content_type and attachment.content_type.startswith('image/') %}
                        <div style="margin-top: 12px;">
                            {% if attachment.downloaded and attachment.local_filename %}
                            <img src="{{ url_for('serve_attachment', filename=attachment.local_filename) }}" 
                                 alt="{{ attachment.filename }}" 
                                 style="max-width: 100%; max-height: 400px; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);"
                                 onclick="window.open(this.src, '_blank')">
                            {% else %}
                            <a href="{{ attachment.url }}" target="_blank" class="btn btn-ghost" style="padding: 8px 12px;">
                                🖼️ View Image (External)
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Embeds -->
            {% if item.embeds %}
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 12px; color: #f1f5f9; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    🔗 Embeds ({{ item.embeds|length }})
                </h4>
                {% for embed in item.embeds %}
                <div style="border-left: 4px solid #6b7280; padding: 16px; background: #1a1a1a; margin-bottom: 12px; border-radius: 8px;">
                    {% if embed.title %}
                    <div style="font-weight: 600; margin-bottom: 8px; color: #f1f5f9;">{{ embed.title }}</div>
                    {% endif %}
                    {% if embed.description %}
                    <div style="margin-bottom: 8px; color: #cbd5e1; line-height: 1.5;">{{ embed.description }}</div>
                    {% endif %}
                    {% if embed.url %}
                    <div><a href="{{ embed.url }}" target="_blank" style="color: #60a5fa; text-decoration: none; font-weight: 500;">{{ embed.url }}</a></div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Reactions -->
            {% if item.reactions %}
            <div style="margin-bottom: 20px;">
                <h4 style="margin-bottom: 12px; color: #f1f5f9; font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    💝 Reactions
                </h4>
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    {% for reaction in item.reactions %}
                    <span style="background: #1a1a1a; border: 1px solid #404040; padding: 6px 12px; border-radius: 20px; font-size: 14px; color: #cbd5e1; font-weight: 500;">
                        {{ reaction.emoji }} {{ reaction.count }}
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Message metadata -->
            <div style="font-size: 12px; color: #64748b; border-top: 1px solid #404040; padding-top: 12px; display: flex; gap: 16px; flex-wrap: wrap;">
                <span>ID: {{ item.id }}</span>
                <span>Created: {{ item.created_at[:19].replace('T', ' ') }}</span>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 80px 20px;">
            <div style="font-size: 64px; margin-bottom: 16px;">📭</div>
            <h3 style="color: #f1f5f9; font-size: 24px; font-weight: 600; margin-bottom: 8px;">No items found</h3>
            <p style="color: #94a3b8; font-size: 16px;">This archive appears to be empty.</p>
        </div>
    {% endif %}
    </div>
</div>

<!-- Search functionality for full messages -->
{% if data.get('archive_type') == 'full_messages' %}
<script>
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const messages = document.querySelectorAll('.message-item');
    
    messages.forEach(function(message) {
        const content = message.getAttribute('data-content') || '';
        if (content.includes(searchTerm)) {
            message.style.display = 'block';
        } else {
            message.style.display = 'none';
        }
    });
});
</script>
{% endif %}
{% endblock %}