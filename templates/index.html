{% extends "base.html" %}

{% block content %}
<div class="search-box">
    <input 
        type="text" 
               html = `
            <div style="padding: 24px;">
                <h2 style="font-size: 24px; font-weight: 600; color: #f1f5f9; margin-bottom: 20px;">
                    Search Results (${results.length})
                </h2>
                <div style="display: grid; gap: 16px;">
        `;archInput" 
        placeholder="üîç Search archives by channel or content..." 
        onkeyup="searchPins()"
    >
</div>

<div id="searchResults" style="display: none; margin-bottom: 24px;"></div>

<div id="allPins" style="padding: 24px;">
    <div style="margin-bottom: 32px;">
        <h2 style="font-size: 28px; font-weight: 600; color: #f1f5f9; margin-bottom: 8px;">Your Archives</h2>
        <p style="color: #94a3b8; font-size: 16px;">Browse your saved Discord pins and messages</p>
    </div>
    
    {% if archive_files %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
            {% for file_data in archive_files %}
            <div style="border: 1px solid #475569; border-radius: 12px; padding: 24px; background: #334155; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);" 
                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(0, 0, 0, 0.4)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0, 0, 0, 0.3)'">
                
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #3b82f6, #1d4ed8); display: flex; align-items: center; justify-content: center; font-size: 20px;">
                        {% if file_data.display_type == 'Full Archive' %}üì¶{% else %}üìå{% endif %}
                    </div>
                    <div style="flex: 1;">
                        <h3 style="color: #f1f5f9; margin-bottom: 4px; font-size: 18px; font-weight: 600;">
                            #{{ file_data.channel_name }}
                        </h3>
                        <p style="color: #94a3b8; font-size: 14px; font-weight: 500;">
                            {% if file_data.display_type == 'Full Archive' %}Full Archive{% else %}Pins Only{% endif %}
                        </p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #94a3b8; font-size: 14px;">Items</span>
                        <span style="color: #f1f5f9; font-weight: 600;">{{ file_data.item_count }}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: #94a3b8; font-size: 14px;">Archived</span>
                        <span style="color: #e2e8f0; font-size: 14px;">{{ (file_data.reset_timestamp or file_data.archive_timestamp)[:10] }}</span>
                    </div>
                </div>
                
                <a href="{{ url_for('view_pins', filename=file_data.filename) }}" 
                   class="btn" 
                   style="width: 100%; justify-content: center; text-align: center;">
                    View Archive
                </a>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div style="text-align: center; padding: 80px 20px;">
            <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #475569, #334155); display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 32px;">üìö</div>
            <h3 style="color: #f1f5f9; font-size: 24px; font-weight: 600; margin-bottom: 12px;">No archives yet</h3>
            <p style="color: #94a3b8; font-size: 16px; max-width: 400px; margin: 0 auto;">Your archived Discord content will appear here when you use the bot's archive commands.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
let searchTimeout;

function searchPins() {
    const query = document.getElementById('searchInput').value.trim();
    const resultsDiv = document.getElementById('searchResults');
    const allPinsDiv = document.getElementById('allPins');
    
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        allPinsDiv.style.display = 'block';
        return;
    }
    
    // Debounce search
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        fetch(`/api/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(results => {
                displaySearchResults(results);
            })
            .catch(error => {
                console.error('Search error:', error);
            });
    }, 300);
}

function displaySearchResults(results) {
    const resultsDiv = document.getElementById('searchResults');
    const allPinsDiv = document.getElementById('allPins');
    
    if (results.length === 0) {
        resultsDiv.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
                <div style="font-size: 48px; margin-bottom: 16px;">üîç</div>
                <h3 style="color: #f1f5f9; margin-bottom: 8px;">No results found</h3>
                <p style="color: #94a3b8;">Try different search terms</p>
            </div>
        `;
    } else {
        let html = `
            <div style="padding: 24px;">
                <h2 style="font-size: 24px; font-weight: 600; color: #1e293b; margin-bottom: 20px;">
                    Search Results (${results.length})
                </h2>
                <div style="display: grid; gap: 16px;">
        `;
        
        results.forEach(result => {
            const pin = result.pin;
            const resetDate = new Date(result.reset_date).toLocaleDateString();
            
            html += `
                <div style="border: 1px solid #475569; border-radius: 12px; padding: 20px; background: #334155; transition: all 0.2s ease;"
                     onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.3)'" 
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <h4 style="color: #f1f5f9; margin-bottom: 4px; font-size: 16px; font-weight: 600;">üì∫ #${result.channel}</h4>
                            <p style="font-size: 12px; color: #94a3b8;">Archived: ${resetDate}</p>
                        </div>
                        <a href="/view/${result.filename}" class="btn btn-ghost" style="padding: 6px 12px; font-size: 14px;">View All</a>
                    </div>
                    <div style="border-left: 3px solid #3b82f6; padding-left: 16px;">
                        <div style="font-weight: 600; margin-bottom: 8px; color: #f1f5f9;">${pin.author.name}</div>
                        <div style="color: #cbd5e1; line-height: 1.5;">${pin.content || '<em style="color: #64748b;">No text content</em>'}</div>
                        ${pin.attachments.length > 0 ? `<div style="font-size: 12px; color: #94a3b8; margin-top: 8px; display: flex; align-items: center; gap: 4px;"><span>üìé</span> ${pin.attachments.length} attachment${pin.attachments.length !== 1 ? 's' : ''}</div>` : ''}
                    </div>
                </div>
            `;
        });
        
        html += '</div></div>';
        resultsDiv.innerHTML = html;
    }
    
    resultsDiv.style.display = 'block';
    allPinsDiv.style.display = 'none';
}
</script>
{% endblock %}