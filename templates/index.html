{% extends "base.html" %}

{% block content %}
<div class="search-box">
    <input 
        type="text" 
        id="searchInput" 
        placeholder="🔍 Search pins by content or author..." 
        onkeyup="searchPins()"
    >
</div>

<div id="searchResults" style="display: none; margin-bottom: 20px;"></div>

<div id="allPins">
    <h2>Saved Pin Archives</h2>
    
    {% if pins_files %}
        <div style="display: grid; gap: 20px; margin-top: 20px;">
            {% for file_data in pins_files %}
            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; background-color: #f8f9fa;">
                <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 15px;">
                    <div>
                        <h3 style="color: #5865f2; margin-bottom: 5px;">
                            📺 #{{ file_data.channel_name }}
                        </h3>
                        <p style="color: #666; font-size: 14px;">
                            📅 Reset: {{ file_data.reset_timestamp[:19].replace('T', ' ') }}
                        </p>
                        <p style="color: #666; font-size: 14px;">
                            📌 {{ file_data.pin_count }} pin{{ 's' if file_data.pin_count != 1 else '' }} saved
                        </p>
                    </div>
                    <a href="{{ url_for('view_pins', filename=file_data.filename) }}" class="btn">
                        View Pins
                    </a>
                </div>
                
                {% if file_data.pins %}
                <div style="border-top: 1px solid #ddd; padding-top: 15px;">
                    <h4 style="margin-bottom: 10px; color: #333;">Preview:</h4>
                    {% for pin in file_data.pins[:2] %}
                    <div style="background: white; padding: 12px; margin-bottom: 8px; border-radius: 5px; border-left: 3px solid #5865f2;">
                        <div style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">
                            {{ pin.author.name }}
                        </div>
                        <div style="font-size: 14px; color: #555;">
                            {% if pin.content %}
                                {{ pin.content[:150] }}{% if pin.content|length > 150 %}...{% endif %}
                            {% else %}
                                <em style="color: #888;">
                                    {% if pin.attachments %}
                                        📎 {{ pin.attachments|length }} attachment{{ 's' if pin.attachments|length != 1 else '' }}
                                    {% elif pin.embeds %}
                                        📄 {{ pin.embeds|length }} embed{{ 's' if pin.embeds|length != 1 else '' }}
                                    {% else %}
                                        No text content
                                    {% endif %}
                                </em>
                            {% endif %}
                        </div>
                        {% if pin.attachments %}
                        <div style="font-size: 12px; color: #888; margin-top: 5px;">
                            📎 {{ pin.attachments|length }} attachment{{ 's' if pin.attachments|length != 1 else '' }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% if file_data.pins|length > 2 %}
                    <div style="font-size: 14px; color: #666; text-align: center;">
                        ... and {{ file_data.pins|length - 2 }} more pin{{ 's' if file_data.pins|length - 2 != 1 else '' }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div style="text-align: center; padding: 40px; color: #666;">
            <h3>No pins saved yet</h3>
            <p>Pins will appear here when channels are reset and pins are archived.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
let searchTimeout;

function searchPins() {
    const query = document.getElementById('searchInput').value.trim();
    const resultsDiv = document.getElementById('searchResults');
    const allPinsDiv = document.getElementById('allPins');
    
    if (query.length < 2) {
        resultsDiv.style.display = 'none';
        allPinsDiv.style.display = 'block';
        return;
    }
    
    // Debounce search
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        fetch(`/api/search?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(results => {
                displaySearchResults(results);
            })
            .catch(error => {
                console.error('Search error:', error);
            });
    }, 300);
}

function displaySearchResults(results) {
    const resultsDiv = document.getElementById('searchResults');
    const allPinsDiv = document.getElementById('allPins');
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No pins found matching your search.</div>';
    } else {
        let html = '<h2>Search Results (' + results.length + ')</h2><div style="display: grid; gap: 15px; margin-top: 20px;">';
        
        results.forEach(result => {
            const pin = result.pin;
            const resetDate = new Date(result.reset_date).toLocaleString();
            
            html += `
                <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background-color: white;">
                    <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <h4 style="color: #5865f2; margin-bottom: 5px;">📺 #${result.channel}</h4>
                            <p style="font-size: 12px; color: #666;">Reset: ${resetDate}</p>
                        </div>
                        <a href="/view/${result.filename}" class="btn" style="padding: 6px 12px; font-size: 14px;">View All</a>
                    </div>
                    <div style="border-left: 3px solid #5865f2; padding-left: 12px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${pin.author.name}</div>
                        <div style="color: #555;">${pin.content || '<em>No text content</em>'}</div>
                        ${pin.attachments.length > 0 ? `<div style="font-size: 12px; color: #888; margin-top: 5px;">📎 ${pin.attachments.length} attachment${pin.attachments.length !== 1 ? 's' : ''}</div>` : ''}
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        resultsDiv.innerHTML = html;
    }
    
    resultsDiv.style.display = 'block';
    allPinsDiv.style.display = 'none';
}
</script>
{% endblock %}